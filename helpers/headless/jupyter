#!/bin/bash
#WHATIS: Jupyter Notebook / Lab
# This script helps run Jupyter (Lab or Notebook) on current machine.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
source "$SCRIPT_DIR/.common.sh"
HELPER_NAME=jupyter

# Save defaults on first run
config_init $HELPER_NAME \
    NCPUS=4 \
    MEM=16G \
    TIME=12:00:00 \
    GPU= \
    BASE_IMAGE= \
    PORT= \
    TOKEN= \
    JUPYTER_MODE=lab \
    REUSE_MODE=ask \
    OVERLAY=env.img

# Load saved defaults
config_load $HELPER_NAME
config_require $HELPER_NAME OVERLAY JUPYTER_MODE
# Track whether a token was set in config
if [ -z "${TOKEN:-}" ]; then AUTH_CONFIG_SET=false; else AUTH_CONFIG_SET=true; fi

print_help() {
    echo "Usage: $0 [options]"
    echo ""
    echo "Options:"
    echo "  -j <lab|notebook>  Run Jupyter Lab or Notebook (default: $JUPYTER_MODE)"
    echo "  -p <port>       Port for $HELPER_NAME (default: ${PORT:-randomly picked}). Valid range: 1024-65535"
    echo "  -a <token>      Connection token for Jupyter (if empty, one is generated)"
    echo "  -w              Use current directory as working directory (clears additional overlays)"
    echo ""
    echo "  -b <image>      Base image file"
    echo "  -e <.img>       Writable overlay (default: $OVERLAY)"
    echo "  -o <overlay>    Additional overlay files (can have multiple -o options)"
    echo ""
    echo "  config          Show config file path and contents"
    echo ""
    echo "State  file: $(state_path $HELPER_NAME)"
    echo "Config file: $(config_path $HELPER_NAME)"
    echo "REUSE_MODE: 'always' (auto-reuse), 'ask' (prompt, default), 'never' (always use config)"
}

case $1 in
    config)         config_show $HELPER_NAME ;;
    --help|-h|help) print_help; exit 0 ;;
    *)              ;;
esac

# Override print_specs to add script-specific fields
print_specs() {
    spec_line "Jupyter Mode" JUPYTER_MODE
    spec_line "Port" PORT
    local cwd_hint=""
    local current_dir="${_ORIGINAL_CWD:-$(readlink -f .)}"
    [ "$CWD" != "$current_dir" ] && cwd_hint=" (use -w for current dir)"
    print_msg "  Working Dir: ${BLUE}$CWD${NC}${cwd_hint}"
    spec_line "Base Image" BASE_IMAGE
    spec_line "Overlay" OVERLAY
    [ -n "$OVERLAYS" ] && print_msg "  Additional overlays: ${BLUE}$OVERLAYS${NC}"
}

REUSE_PREVIOUS_CWD=false
_HAS_PREVIOUS_STATE=false
_STATE_PORT=""

STATE_FILE="$HELPER_STATE_DIR/$HELPER_NAME"
read_headless_state "$STATE_FILE"
case $? in
    3) # Has previous state - handle reuse after arg parse
        _HAS_PREVIOUS_STATE=true
        _STATE_PORT="${PORT:-}"
        print_info "Found previous $HELPER_NAME settings."
        ;;
esac

# Track if -o flag is used to clear overlays on first use
_OVERLAYS_CLEARED=false
# track whether -a supplied a token
AUTH_FLAG_SET=false
# Track if user wants to change working directory
NEW_CWD=""

while getopts "j:p:a:b:e:o:w" opt; do
    case ${opt} in
        j ) JUPYTER_MODE="${OPTARG,,}"; _ARG_JUPYTER_MODE=1 ;;
        w )
            NEW_CWD="$(readlink -f .)"
            if [ "$_OVERLAYS_CLEARED" = false ]; then OVERLAYS=""; _OVERLAYS_CLEARED=true; fi
            ;;
        p ) PORT=$OPTARG; _ARG_PORT=1 ;;
        a ) TOKEN=$OPTARG; AUTH_FLAG_SET=true ;;
        b ) BASE_IMAGE="$OPTARG"; _ARG_BASE_IMAGE=1 ;;
        e ) OVERLAY=$OPTARG; _ARG_OVERLAY=1 ;;
        o ) # First -o clears previous overlays, then builds fresh list
            if [ "$_OVERLAYS_CLEARED" = false ]; then OVERLAYS=""; _OVERLAYS_CLEARED=true; fi
            OVERLAYS="${OVERLAYS:+$OVERLAYS:}$OPTARG"
            ;;
        \? ) print_help; exit 2 ;;
    esac
done

# Handle reuse mode (after arg parse)
if [ "$_HAS_PREVIOUS_STATE" = true ]; then
    handle_reuse_mode "$HELPER_NAME"
fi

# Handle working directory changes
if [ -n "$NEW_CWD" ]; then
    CWD="$NEW_CWD"
elif [ "$REUSE_PREVIOUS_CWD" = true ]; then
    cd "$CWD"
fi

# Resolve port: CLI > config > state
if [ -z "${_ARG_PORT:-}" ] && [ "$REUSE_PREVIOUS_CWD" != true ]; then
    if [ -n "${_CONFIG_PORT:-}" ]; then
        PORT="$_CONFIG_PORT"
    elif [ -n "$_STATE_PORT" ]; then
        PORT="$_STATE_PORT"
    fi
fi

# Show settings (once)
if [ "$_SPECS_SHOWN" != true ]; then
    print_msg "Using settings:"
    print_specs
    countdown 5
fi

# If no port specified, pick an available one
if [ -z "$PORT" ]; then
    PORT=$(choose_port) || {
        print_error "Failed to find an available port. Please specify one with -p."
        exit 1
    }
    print_info "Available port :${BLUE}$PORT${NC} auto-selected."
    print_info "Remember to set up port forwarding: ${CYAN}ssh -L $PORT:localhost:$PORT $USER@$HOSTNAME${NC}"
    if ! confirm_default_yes "Proceed with this port?"; then
        echo "Aborted by user."; exit 1
    fi
else
    validate_port "$PORT"
fi

#region Sanity Checks
check_port_available "$PORT"
check_condatainer

check_and_install_overlays $OVERLAYS

if [ ! -f "$OVERLAY" ]; then
    print_error "Overlay ${BLUE}$OVERLAY${NC} not found."
    exit 1
else
    # Verify overlay contains the required Jupyter executable for the selected mode
    if [ "$JUPYTER_MODE" = "notebook" ]; then
        if ! debugfs -R "stat upper/ext3/env/bin/jupyter-notebook" $OVERLAY 2>&1 | grep -q 'Inode'; then
            ABS_OVERLAY_PATH=$(readlink -f "$OVERLAY")
            print_error "Overlay ${BLUE}$ABS_OVERLAY_PATH${NC} does not contain jupyter-notebook."
            print_info "Please go into the overlay shell and run 'mm-install notebook' to install jupyter-notebook."
            exit 1
        fi
    else
        if ! debugfs -R "stat upper/ext3/env/bin/jupyter-lab" $OVERLAY 2>&1 | grep -q 'Inode'; then
            ABS_OVERLAY_PATH=$(readlink -f "$OVERLAY")
            print_error "Overlay ${BLUE}$ABS_OVERLAY_PATH${NC} does not contain jupyter-lab."
            print_info "Please go into the overlay shell and run 'mm-install jupyterlab' to install jupyter-lab."
            exit 1
        fi
    fi
    check_overlay_integrity "$OVERLAY"
fi
#endregion

# Construct arguments for CondaTainer exec
[ -n "$BASE_IMAGE" ] && BASE_IMAGE_ARG="-b $BASE_IMAGE"
[ -n "$OVERLAY" ] && [ -f "$OVERLAY" ] && OVERLAY_ARG="-o $OVERLAY"
[ -n "$OVERLAYS" ] && OVERLAYS_ARG=$(build_overlays_arg "$OVERLAYS")

# Decide jupyter command
if [ "$JUPYTER_MODE" = "notebook" ]; then
    JUPYTER_CMD="jupyter-notebook"
else
    JUPYTER_CMD="jupyter-lab"
fi

# Generate a random token if not provided by config or -a
if [ "${AUTH_FLAG_SET:-false}" = "false" ] && [ "${AUTH_CONFIG_SET:-false}" = "false" ]; then
    print_info "No connection token provided. Generating a random one..."
    TOKEN=$(openssl rand -hex 8 2>/dev/null || tr -dc 'a-zA-Z0-9' </dev/urandom | head -c 16 || echo "$(date +%s)-$RANDOM")
fi

# Save state before running
cat > "$STATE_FILE" <<RUNSTATE
PORT=$PORT
CWD=$CWD
JUPYTER_MODE="$JUPYTER_MODE"
BASE_IMAGE="$BASE_IMAGE"
OVERLAY="$OVERLAY"
OVERLAYS="$OVERLAYS"
RUNSTATE

print_info "Starting $HELPER_NAME at ${BLUE}http://localhost:$PORT?token=$TOKEN${NC}"

condatainer exec \
    $BASE_IMAGE_ARG \
    $OVERLAYS_ARG \
    $OVERLAY_ARG --writable \
    $JUPYTER_CMD \
        --ip 127.0.0.1 \
        --port $PORT \
        --no-browser \
        --IdentityProvider.token $TOKEN
